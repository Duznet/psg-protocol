# PSG-protocol (Platform shooter game protocol)

Протокол обмена сообщениями между клиентом и сервером

Сообщения передаются в формате JSON методом POST

## Формат сообщений

### Запрос (Request)

    {
        // Самое действие
        "action": "<action>",

        // Параметры, специфичные для конкретного действия
        "params": {
            "<paramName1>": <paramValue1>,
            ...
        }
    }

#### Пример

    {
        "action": "signup",
        "params": {
            "login": "admin",
            "password": "banana"
        }
    }


### Ответ (Response)

    {
        // В случае успешного выполнения команды "<result>" == "ok".
        // В случае ошибки передается ее код
        // Если в запросе несколько ошибок, например, badLogin и badPassword, в поле result передается любая из них
        // Если команда не найдена, передается код ошибки "unknownAction"
        "result": "<result>",

        // Текстовый комментарий. Может быть произвольным
        "message": "<message>"
    }

Базовые коды ошибок:

* badJSON (Запрос имеет не json формат)
* paramMissed (Запрос содержит не все требуемые поля)

#### Пример ответа в случае успеха

    {
        "result": "ok"
    }

#### Пример ответа в случае ошибки

    {
        "result": "userExists",
        "message": "Такой пользователь уже существует"
    }


## Действия

### startTesting

Коды ошибок:

- notInTestMode (Сервер не в тестирующем режиме)


### signup

Параметры:

* login => строковое значение.
    - минимальная длина: 4 символа
    - макисмальная длина: 40 символов
* password => строковое значение.
    - минимальная длина: 4 символа

Коды ошибок:

* userExists (Такой пользователь уже существует)
* badLogin (Некорректный логин)
* badPassword (Некорректный пароль)

### signin

Параметры:

* login => строковое значение
    - минимальная длина: 4 символа
    - макисмальная длина: 40 символов
* password => строковое значение
    - минимальная длина: 4 символа

Ответ:

* sid => латинские буквы и цифры, не короче 1 символа

Коды ошибок:

* incorrect (Некорректный логин/пароль)

### signout

Параметры:

* sid => латинские буквы и цифры, не короче 1 символа

Коды ошибок:

* badSid (Некорректный sid)

---

### sendMessage

Параметры:

* sid => латинские буквы и цифры, не короче 1 символа
* game => число, идентификатор игры. Пустая строка -- для общего чата
* text => текст сообщения, строковое значение

Коды ошибок:

* badSid (Некорректный sid)
* badGame (Некорректный идентификатор игры)
* badText (Некорректный текст сообщения)

### getMessages

Параметры:

* sid => латинские буквы и цифры, не короче 1 символа
* game => число, идентификатор игры. Пустая строка -- для общего чата
* since => Unix timestamp UTC

Ответ:

* messages => массив, отсортированный *по возрастанию* времени

Элемент массива messages:

    {
        // Время в формате Unix timestamp UTC
        "time": <time>,

        // Текст сообщения
        "text": "<text>",

        // Логин отправителя
        "login": "<login>"
    }

    - time => Unix timestamp UTC
    - text => строковое значение
    - login => строковое значение
        + минимальная длина: 4 символа
        + максимальная длина: 40 символов

Коды ошибок:

* badSid (Некорректный sid)
* badGame (Некорректный идентификатор игры)
* badSince (Некорректное время)

---

### createGame

Параметры:

* sid => латинские буквы и цифры, не короче 1 символа
* name => название игры, строковое значение, не короче одного символа
* map => число, идентификатор карты
* maxPlayers => максимально допустимое число игроков

Коды ошибок:

* badSid (Некорректный sid)
* badName (Некорректное название игры)
* badMap (Некорректный идентификатор карты)
* badMaxPlayers (Некорректное максимальное число игроков)
* gameExists (Игра с таким названием уже существует)
* alreadyInGame (Пользователь уже в игре)

### getGames

Параметры:

* sid

Ответ:

* games => массив игр

Элемент массива games:

    {
        // Число, идентификатор игры
        id: "<id>",

        // Строка, название игры
        name: "<name>",

        // Число, идентификатор карты
        map: <map>,

        // Число, макисмальное количество игроков
        maxPlayers: <maxPlayers>,

        // Массив логинов игроков, отсортированный в порядке подключения
        players: ["<login1>", "<login2>", ... ],

        // Строка, состояние игры. Допустимые значения: running, finished
        status: "<status>"
    }

Коды ошибок:

* badSid (Некорректный sid)

### joinGame

Параметры:

* sid => латинские буквы и цифры, не короче 1 символа
* game => число, идентификатор игры

Коды ошибок:

* badSid (Некоректный sid)
* gameFull (Игра заполнена)
* badGame (Некорректный идентификатор игры)
* alreadyInGame (Пользователь уже в игре)

### leaveGame

Параметры:

* sid => латинские буквы и цифры, не короче 1 символа

Коды ошибок:

* notInGame (Игрок не участвует ни в одной игре)

### uploadMap

Параметры:

* sid => латинские буквы и цифры, не короче 1 символа
* name => название игры, строковое значение
* map: ["<row1>", "<row2>", ...] => массив строк, описывающих карту. Длины строк должны быть равны
* maxPlayers => максимальное число игроков для этой карты, число

Коды ошибок:

* badSid (Некорректный sid)
* badName (Некорректное название карты)
* badMap (Некорректные данные карты)
* badMaxPlayers (Некорректное максимальное число игроков)
* mapExists (Карта с таким названием уже существует)

#### Спецификация карты

Строки должны быть одинаковой длины (Карта прямоугольная)

Допустимые символы:

+ ```.``` - пустое место
+ ```$``` - место респауна
+ ```#``` - стенка (считается, что стенки непробиваемые)
+ [a-z] - предметы. *Пока про предметы не договорились*
+ [A-Z] - оружиe:
    - ```K``` - knife
    - ```P``` - pistol
    - ```M``` - machine gun
    - ```R``` - rocket launcher
    - ```A``` - railgun
+ [0-9] - телепорты (Одинаковые цифры обозначают входы и выходы одного телепорта)

Пример:

    .2.....1....2.
    .#R..$.1.M..#.
    .############.
    ..............

Минимальный размер карты - 1 x 1 клетка

### getMaps

Параметры:

* sid => латинские буквы и цифры, не короче 1 символа

Ответ:

* maps => массив карт

Элемент массива карт:

    {
        // Число, идентификатор карты
        id: "<id>",

        // Строка, название карты
        name: "<name>",

        // Число, макисмальное количество игроков
        maxPlayers: <maxPlayers>,

        // Данные карты в виде массива строк. Длины строк должны быть равны
        map: ["<row1>", "<row2>", ...]
    }

Коды ошибок:

* badSid (Некорректный sid)

Запросы, требующие websocket
----------------------------

Запросы, требующие websocket, предлагается отправлять на /websocket (Например, http://localhost/websocket, если запросы без websocket отправлялись на localhost)

### move

Параметры:

* sid => латинские буквы и цифры, не менее 1 символа
* tick => число, номер игрового тика
* move => объект, поля:
    - dx => число, смещение игрока по x
    - dy => число, смещение игрока по y
* fire => объект, поля:
    - dx => число, смещение координат выстрела по x
    - dy => число, смещение координат выстрела по y

Ответ:

* tick => число, номер игрового тика
* players => массив объектов, описывающих каждого игрока. В порядке подключения к игре
    - x => число, координата x игрока
    - y => число, координата y игрока
    - vx => число, скорость по оси x игрока
    - vy => число, скорость по оси y игрока
    - health => число, процент здоровья игрока
    - status => "dead" или "alive" - статус игрока
    - respawn => число, время в миллисекундах до респауна игрока. В случае, если status == "alive", поле не требуется
    - projectiles => массив объектов, описывающих снаряды
        + x => число, x-компонента координат снаряда
        + y => число, y-компонента координат снаряда
        + vx => число, скорость по оси x снаряда
        + vy => число, скорость по оси y снаряда
        + owner => число, индекс игрока в массиве players, который сделал выстрел
    - items => массив, каждый элемент - время до восстановления i-го предмета на карте. Предметы нумеруются относительно расположения на карте слева направо сверху вниз
